# description: Installs the native Azure "IaaS Antivirus" Extension on the Azure VM. Useful to comply with Azure Security Center Policies.
#tags: Nerdio
<# 
Notes:
This Script will install the Microsoft Antimalware extension on the Azure VM.
See MS Doc for details: https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/iaas-antimalware-windows

Antimalware Extension settings can be edited below. Be sure to maintain JSON formatting if changes are made
#>

# Set Error action
$errorActionPreference = "Stop"

# Ensure context is using correct subscription
Set-AzContext -SubscriptionId $AzureSubscriptionId

# Variables
$AzVM = Get-AzVM -Name $AzureVMName -ResourceGroupName $AzureResourceGroupName
$PublisherName = "Microsoft.Azure.Security"
$Type = "IaaSAntimalware"

# Get the latest major version for Antimalware Extension
$amversion = ((Get-AzVMExtensionImage -Location $AzVM.Location -PublisherName $PublisherName -Type $Type).Version[-1][0..2] -join '')

<# 
Antimalware extension settings, exclusions and schedules. Feel free to edit to achieve desired config.
This setting will run a quick scan at 2AM everyday, and exclude .log and .ldf files.
See https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/iaas-antimalware-windows#template-deployment
and https://docs.microsoft.com/en-us/azure/security/fundamentals/antimalware-code-samples#deploy-microsoft-antimalware-on-azure-resource-manager-vms
for details
#>
$amsettings = @'
{
    "AntimalwareEnabled": true,
    "RealtimeProtectionEnabled": true,
    "ScheduledScanSettings": {
        "isEnabled": true,
        "day": 7,
        "time": 120,
        "scanType": "Quick"
    },
    "Exclusions": {
        "Extensions": ".log,.ldf",
            "Processes": "mssence.svc"
    }
}
'@

#enable the Microsoft Antimalware Extension with the above settings
$AMExtension = @{
    ResourceGroupName = $AzVM.ResourceGroupName
    Location           = $AzVM.Location
    VMName             = $AzureVMName
    Name               = $Type
    Publisher          = $PublisherName
    ExtensionType      = $Type
    SettingString      = $amsettings
    TypeHandlerVersion = $amversion
}
Set-AzVMExtension @AMExtension
